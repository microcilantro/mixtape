# Deploying Transitmix to Railway.app

## Prerequisites
1. A Railway account (https://railway.app)
2. Git installed locally
3. The updated codebase with fixes

## Step 1: Prepare Your Repository

1. Replace the `Gemfile` with the updated version (debugger → debug)
2. Add the `railway.toml` and `nixpacks.toml` files to your repo
3. Commit all changes:
   ```bash
   git add .
   git commit -m "Prepare for Railway deployment"
   ```

## Step 2: Create a New Railway Project

1. Go to https://railway.app/new
2. Click "Deploy from GitHub repo"
3. Select your Transitmix repository
4. Railway will automatically detect it's a Ruby app

## Step 3: Add PostgreSQL Database

1. In your Railway project, click "+ New"
2. Select "Database" → "PostgreSQL"
3. Railway will automatically create a DATABASE_URL environment variable

## Step 4: Configure Environment Variables

In Railway project settings, add these environment variables:

### Required:
- `DATABASE_URL` - Auto-generated by Railway PostgreSQL
- `PORT` - Set to `3000` (or Railway will set automatically)

### Optional (for production):
- `GOOGLE_ANALYTICS` - Your Google Analytics ID (if you want analytics)
- `UNICORN_WORKERS` - Number of workers (default: 4)
- `UNICORN_BACKLOG` - Connection backlog (default: 200)

### API Keys (Required for full functionality):
You'll need to update the codebase with your own API keys:
- **Mapbox API Key** - The app currently uses `codeforamerica.h6mlbj75`
  - Sign up at https://www.mapbox.com/
  - Replace in `app/js/app.js` and `app/js/utils.js`
  
- **Google Maps Geocoding API Key** - Currently uses a hardcoded key
  - Get one at https://console.cloud.google.com/
  - Replace in `app/js/views/HomeView.js`

## Step 5: Deploy

1. Railway will automatically deploy when you push to your connected branch
2. Watch the deployment logs in Railway dashboard
3. The app will:
   - Install dependencies
   - Run database migrations
   - Start the Unicorn web server

## Step 6: Verify Deployment

1. Click "Open App" in Railway dashboard
2. You should see the Transitmix home page
3. Try creating a new map to test functionality

## Common Issues & Solutions

### Issue: Database connection failed
**Solution:** Make sure the PostgreSQL service is running and DATABASE_URL is set

### Issue: Migration errors
**Solution:** Check that all migrations are present in `db/migrations/`

### Issue: Port binding error
**Solution:** Ensure your app uses `ENV['PORT']` (already configured in config/unicorn.rb)

### Issue: Asset compilation errors
**Solution:** Make sure all required gems are installed (sass, uglifier, etc.)

### Issue: API key errors (Mapbox/Google Maps)
**Solution:** The embedded API keys may not work. You need to:
1. Get your own Mapbox account and token
2. Get a Google Maps Geocoding API key
3. Update the JavaScript files with your keys

## Environment-Specific Configuration

Railway sets these automatically:
- `RAILWAY_ENVIRONMENT` - The environment name
- `RAILWAY_SERVICE_NAME` - Your service name
- `DATABASE_URL` - PostgreSQL connection string

## Post-Deployment Steps

1. **Test the application**
   - Create a new map
   - Draw a transit line
   - Verify calculations work

2. **Monitor logs**
   - Check Railway logs for any errors
   - Monitor database connections

3. **Set up custom domain** (optional)
   - In Railway settings, add your custom domain
   - Update DNS records as instructed

## Updating API Keys

After deployment, you should update the hardcoded API keys:

1. Create environment variables in Railway:
   ```
   MAPBOX_TOKEN=your_mapbox_token
   MAPBOX_STYLE=your_mapbox_style_id
   GOOGLE_MAPS_API_KEY=your_google_api_key
   ```

2. Update the code to use environment variables (requires code changes)

## Rollback (if needed)

If deployment fails:
1. Go to Railway dashboard
2. Click on the failed deployment
3. Click "Rollback" to return to previous version

## Support

- Railway Docs: https://docs.railway.app/
- Railway Discord: https://discord.gg/railway
- Transitmix Issues: https://github.com/codeforamerica/transitmix/issues
